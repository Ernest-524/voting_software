{% extends 'main/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/vote.css' %}">
<style>
    /* Additional styles for the new voting system */
    .candidate-radio-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin: 20px 0;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
    }
    
    .radio-option {
        display: flex;
        align-items: center;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: white;
    }
    
    .radio-option:hover {
        border-color: #4CAF50;
        background-color: #f1f8e9;
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .radio-option.selected {
        border-color: #4CAF50;
        background-color: #e8f5e9;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
    }
    
    .radio-option input[type="radio"] {
        margin-right: 15px;
        transform: scale(1.2);
    }
    
    .radio-candidate-info {
        display: flex;
        align-items: center;
        gap: 20px;
        width: 100%;
    }
    
    .candidate-photo-small {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .radio-candidate-details {
        flex: 1;
    }
    
    .single-candidate-note {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
        font-style: italic;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
        display: inline-block;
    }
    
    .multiple-candidate-note {
        font-size: 1em;
        color: #3E2723;
        margin-bottom: 15px;
        font-weight: 500;
        padding: 10px 15px;
        background-color: #e3f2fd;
        border-radius: 6px;
        border-left: 4px solid #2196F3;
    }
    
    .position-block {
        margin-bottom: 40px;
        padding: 25px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: 1px solid #e0e0e0;
    }
    
    .position-block h3 {
        color: #3E2723;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .position-description {
        color: #666;
        margin-bottom: 20px;
        font-size: 0.95em;
    }
    
    .no-candidates {
        text-align: center;
        padding: 30px;
        color: #999;
        font-style: italic;
        background-color: #f9f9f9;
        border-radius: 8px;
        border: 2px dashed #ddd;
    }
    
    .vote-controls {
        display: flex;
        gap: 10px;
        margin-left: auto;
    }
    
    .btn-yes, .btn-no {
        padding: 10px 25px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        min-width: 80px;
    }
    
    .btn-yes {
        background-color: #4CAF50;
        color: white;
    }
    
    .btn-yes:hover:not(:disabled) {
        background-color: #388E3C;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
    }
    
    .btn-yes.selected {
        background-color: #1B5E20;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
    }
    
    .btn-no {
        background-color: #f44336;
        color: white;
    }
    
    .btn-no:hover:not(:disabled) {
        background-color: #d32f2f;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
    }
    
    .btn-no.selected {
        background-color: #b71c1c;
        box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.3);
    }
    
    .btn-yes:disabled, .btn-no:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }
    
    .candidate-block {
        display: flex;
        align-items: center;
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        margin-bottom: 15px;
        transition: border-color 0.3s;
        gap: 20px;
    }
    
    .candidate-block:hover {
        border-color: #bdbdbd;
    }
    
    .candidate-info {
        flex: 1;
    }
    
    .candidate-name {
        font-weight: 600;
        font-size: 1.1em;
        color: #333;
        margin-bottom: 5px;
    }
    
    .candidate-role {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 5px;
    }
    
    .btn-vote {
        padding: 15px 40px;
        font-size: 1.1rem;
        border-radius: 8px;
        background: linear-gradient(135deg, #3E2723, #5D4037);
        color: #fff;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(62, 39, 35, 0.3);
    }
    
    .btn-vote:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(62, 39, 35, 0.4);
        background: linear-gradient(135deg, #5D4037, #3E2723);
    }
    
    .btn-vote:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }
    
    .voting-closed {
        background: linear-gradient(135deg, #fdecea, #ffebee);
        color: #b00020;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
        font-size: 1.1em;
        font-weight: 500;
        border: 2px solid #ffcdd2;
        box-shadow: 0 4px 10px rgba(176, 0, 32, 0.1);
    }
    
    .form-errors {
        background-color: #ffebee;
        border: 2px solid #ffcdd2;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .form-errors ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .form-errors li {
        margin-bottom: 5px;
    }
    
    /* NEW STYLES FOR ELECTION STATUS */
    .election-status {
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
        font-weight: 600;
        font-size: 1.2em;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .election-active {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        color: #1b5e20;
        border: 3px solid #4caf50;
    }
    
    .election-inactive {
        background: linear-gradient(135deg, #ffebee, #ffcdd2);
        color: #b71c1c;
        border: 3px solid #f44336;
    }
    
    .time-remaining {
        display: inline-block;
        background: #1b5e20;
        color: white;
        padding: 8px 20px;
        border-radius: 25px;
        margin-left: 15px;
        font-size: 1em;
        font-weight: 700;
        box-shadow: 0 3px 8px rgba(27, 94, 32, 0.3);
    }
    
    .election-closed-message {
        text-align: center;
        padding: 50px 20px;
        background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
        border-radius: 15px;
        margin-top: 30px;
        border: 3px dashed #9e9e9e;
    }
    
    .election-closed-message i {
        font-size: 64px;
        color: #757575;
        margin-bottom: 20px;
        display: block;
    }
    
    .admin-controls {
        margin-top: 30px;
        padding: 20px;
        background: #e3f2fd;
        border-radius: 10px;
        border-left: 5px solid #2196f3;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .candidate-block {
            flex-direction: column;
            text-align: center;
            gap: 15px;
        }
        
        .vote-controls {
            margin-left: 0;
            width: 100%;
            justify-content: center;
        }
        
        .radio-option {
            flex-direction: column;
            text-align: center;
            gap: 10px;
        }
        
        .radio-candidate-info {
            flex-direction: column;
            gap: 10px;
        }
        
        .radio-option input[type="radio"] {
            margin-right: 0;
            margin-bottom: 10px;
        }
        
        .time-remaining {
            display: block;
            margin: 15px auto 0;
            width: fit-content;
        }
        
        .election-status {
            font-size: 1em;
            padding: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="vote-container">
    <h2>Cast Your Vote</h2>

    <!-- ========== ELECTION STATUS DISPLAY ========== -->
    {% if is_election_active %}
        <div class="election-status election-active">
            <i class="fas fa-vote-yea"></i> ELECTION IS CURRENTLY ACTIVE
            {% with remaining=election_settings.get_remaining_time %}
                {% if remaining %}
                    <span class="time-remaining">
                        <i class="fas fa-clock"></i> Time remaining: {{ remaining|timeuntil }}
                    </span>
                {% endif %}
            {% endwith %}
        </div>
    {% else %}
        <div class="election-status election-inactive">
            <i class="fas fa-ban"></i> ELECTION IS NOT ACTIVE
            {% if election_settings.scheduled_start %}
                <p style="margin-top: 15px; font-size: 1em; font-weight: normal; color: #666;">
                    <i class="fas fa-calendar-alt"></i> 
                    Next election scheduled for: <strong>{{ election_settings.scheduled_start|date:"F j, Y, g:i a" }}</strong>
                </p>
            {% endif %}
        </div>
    {% endif %}
    <!-- ========== END ELECTION STATUS ========== -->

    {% if voting_closed %}
        <div class="voting-closed">
            <i class="fas fa-clock" style="margin-right: 10px;"></i>
            Voting has ended for today. Thank you.
        </div>
    {% endif %}

    <!-- ========== CHECK IF ELECTION IS ACTIVE ========== -->
    {% if not is_election_active and not voting_closed %}
        <!-- Don't show voting form if election is not active -->
        <div class="election-closed-message">
            <i class="fas fa-lock"></i>
            <h3 style="color: #616161;">Voting is currently closed</h3>
            <p style="color: #757575; max-width: 600px; margin: 10px auto 20px;">
                The election period has not started yet or has already ended. 
                Please wait for the election to begin or contact the administrator for more information.
            </p>
            
            {% if election_settings.scheduled_start %}
                <div style="background: white; padding: 15px; border-radius: 8px; display: inline-block; margin: 15px 0;">
                    <i class="fas fa-calendar-check" style="color: #2196F3; margin-right: 8px;"></i>
                    <strong>Next Election:</strong> {{ election_settings.scheduled_start|date:"l, F j, Y" }} at {{ election_settings.scheduled_start|time:"g:i a" }}
                </div>
            {% endif %}
            
            {% if request.user.is_superuser or request.user.is_staff %}
                <div class="admin-controls">
                    <h4 style="color: #1565C0; margin-top: 0;">
                        <i class="fas fa-user-shield"></i> Administrator Access
                    </h4>
                    <p style="color: #1976D2;">
                        You have administrator privileges. You can manage election settings to start voting.
                    </p>
                    <a href="{% url 'manage_election' %}" class="btn-vote" style="background: linear-gradient(135deg, #1565C0, #0D47A1);">
                        <i class="fas fa-cog"></i> Manage Election Settings
                    </a>
                </div>
            {% endif %}
        </div>
    {% elif is_election_active and not voting_closed %}
        <!-- Show voting form ONLY if election is active -->
        <form method="POST" id="vote-form">
            {% csrf_token %}
            {% if form.errors %}
                <div class="form-errors">
                    <h4 style="margin-top: 0; color: #b00020;">
                        <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
                        Please fix the following errors:
                    </h4>
                    <ul>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% for position in positions %}
                <div class="position-block">
                    <h3>{{ position.position_name }}</h3>
                    {% if position.description %}
                        <p class="position-description">{{ position.description }}</p>
                    {% endif %}
                    
                    {% with candidate_count=position.candidate_position.count %}
                        {% if candidate_count > 1 %}
                            <!-- Multiple candidates - radio selection -->
                            <div class="multiple-candidate-note">
                                <i class="fas fa-users" style="margin-right: 8px;"></i>
                                Select ONE candidate for this position:
                            </div>
                            <div class="candidate-radio-group" id="position-{{ position.id }}">
                                {% for candidate in position.candidate_position.all %}
                                    <label class="radio-option" id="option-{{ candidate.id }}">
                                        <input type="radio" 
                                               name="position_{{ position.id }}" 
                                               value="{{ candidate.id }}"
                                               onclick="selectCandidate('{{ position.id }}', '{{ candidate.id }}')"
                                               {% if voting_closed %}disabled{% endif %}>
                                        <div class="radio-candidate-info">
                                            {% if candidate.photo %}
                                                <img src="{{ candidate.photo.url }}" class="candidate-photo-small" alt="{{ candidate.candidate_name.first_name }}">
                                            {% else %}
                                                <img src="{% static 'images/default-avatar.png' %}" class="candidate-photo-small" alt="No photo">
                                            {% endif %}
                                            <div class="radio-candidate-details">
                                                <div class="candidate-name">{{ candidate.candidate_name.first_name }} {{ candidate.candidate_name.last_name }}</div>
                                                <div class="candidate-role">{{ position.position_name }} Candidate</div>
                                            </div>
                                        </div>
                                    </label>
                                {% empty %}
                                    <div class="no-candidates">
                                        <i class="fas fa-user-slash" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                        No candidates for this position yet.
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <!-- Single candidate - yes/no buttons -->
                            <div class="candidate-options">
                                {% for candidate in position.candidate_position.all %}
                                    <div class="candidate-block" id="candidate-row-{{ candidate.id }}">
                                        {% if candidate.photo %}
                                            <img src="{{ candidate.photo.url }}" class="candidate-photo" alt="{{ candidate.candidate_name.first_name }}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                                        {% else %}
                                            <img src="{% static 'images/default-avatar.png' %}" class="candidate-photo" alt="No photo" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                                        {% endif %}
                                        <div class="candidate-info">
                                            <div class="candidate-name">{{ candidate.candidate_name.first_name }} {{ candidate.candidate_name.last_name }}</div>
                                            <div class="candidate-role">{{ position.position_name }}</div>
                                            <div class="single-candidate-note">
                                                <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                                                Click Yes to support, No to reject.
                                            </div>
                                        </div>

                                        <div class="vote-controls" data-candidate="{{ candidate.id }}">
                                            <input type="hidden" name="candidate_{{ candidate.id }}" id="candidate_{{ candidate.id }}" value="">
                                            <button type="button" class="btn-yes" onclick="selectVote('{{ candidate.id }}','yes', this)" aria-label="Vote Yes for {{ candidate.candidate_name.first_name }}" {% if voting_closed %}disabled{% endif %}>
                                                <i class="fas fa-check" style="margin-right: 5px;"></i>Yes
                                            </button>
                                            <button type="button" class="btn-no" onclick="selectVote('{{ candidate.id }}','no', this)" aria-label="Vote No for {{ candidate.candidate_name.first_name }}" {% if voting_closed %}disabled{% endif %}>
                                                <i class="fas fa-times" style="margin-right: 5px;"></i>No
                                            </button>
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="no-candidates">
                                        <i class="fas fa-user-slash" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                        No candidates for this position yet.
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>
            {% endfor %}

            <div style="text-align:center; margin-top:30px; padding-top:20px; border-top: 2px solid #f0f0f0;">
                <button type="submit" class="btn-vote" {% if voting_closed %}disabled{% endif %}>
                    {% if voting_closed %}
                        <i class="fas fa-lock" style="margin-right: 10px;"></i>Voting Closed
                    {% else %}
                        <i class="fas fa-paper-plane" style="margin-right: 10px;"></i>Submit Vote
                    {% endif %}
                </button>
                <p style="color: #666; margin-top: 15px; font-size: 0.9em;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 5px; color: #FF9800;"></i>
                    Note: You can only vote once. Make sure your selections are final.
                </p>
                
                <!-- Election Information Footer -->
                <div style="margin-top: 25px; padding: 15px; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #666;">
                    <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                    <strong>Election Information:</strong> 
                    {{ election_settings.election_name }}
                    {% if election_settings.is_manual_override %}
                        | <span style="color: #ff9800;"><i class="fas fa-hand-paper"></i> Manual Mode</span>
                    {% else %}
                        | <span style="color: #4caf50;"><i class="fas fa-robot"></i> Scheduled Mode</span>
                    {% endif %}
                </div>
            </div>
        </form>
    {% endif %}
</div>

<script>
// For single candidate yes/no selection
function selectVote(candidateId, value, btn) {
    var hidden = document.getElementById('candidate_' + candidateId);
    if (!hidden) return;
    hidden.value = value;
    var container = btn.parentElement;
    var buttons = container.querySelectorAll('button');
    buttons.forEach(function(b) { 
        b.classList.remove('selected'); 
        b.style.transform = '';
    });
    btn.classList.add('selected');
    btn.style.transform = 'scale(1.05)';
    var row = document.getElementById('candidate-row-' + candidateId);
    if (row) {
        row.style.borderColor = (value === 'yes') ? '#4CAF50' : '#f44336';
        row.style.boxShadow = (value === 'yes') 
            ? '0 4px 12px rgba(76, 175, 80, 0.2)' 
            : '0 4px 12px rgba(244, 67, 54, 0.2)';
    }
}

// For multiple candidate radio selection
function selectCandidate(positionId, candidateId) {
    var options = document.querySelectorAll('#position-' + positionId + ' .radio-option');
    options.forEach(function(option) {
        option.classList.remove('selected');
        option.style.transform = '';
    });
    var selectedOption = document.getElementById('option-' + candidateId);
    if (selectedOption) {
        selectedOption.classList.add('selected');
        selectedOption.style.transform = 'translateY(-3px)';
    }
}

// Form submission - SIMPLIFIED VERSION
document.getElementById('vote-form').addEventListener('submit', function(evt) {
    // Show loading indicator
    var submitBtn = document.querySelector('.btn-vote');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        submitBtn.disabled = true;
    }
    
    // Allow form to submit normally - NO validation alerts
    return true;
});

// Add CSS animation for error highlighting
var style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255, 87, 34, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}